<div class="dashboard-container">
    <ht-card [title]="'My Dashboard'">
        <!-- Next Task Widget Card -->
        <div *ngIf="!loading && isToday(selectedDate)" class="next-task-widget">
            <ng-container *ngIf="nextTaskInfo; else allDone">
                <div class="next-task-card" [style.transform]="'translateX(' + dragTranslateX + 'px)'"
                    [style.transition]="isDragging ? 'none' : 'transform 200ms ease'"
                    (pointerdown)="onPointerDown($event)" (pointermove)="onPointerMove($event)"
                    (pointerup)="onPointerUp($event)" (pointercancel)="onPointerCancel()"
                    (mouseleave)="onPointerCancel()" (touchstart)="onTouchStart($event)"
                    (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)" tabindex="0" role="region"
                    aria-label="Next Task Carousel">
                    <div class="next-task-swipe-row">
                        <div
                            style="width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 0.3rem; gap: 0.5rem;">
                            <button (click)="goToPrevTask()" [disabled]="sliderValue <= 1"
                                style="background: none; border: none; color: #ffe082; font-size: 3em; cursor: pointer;">&#8592;</button>
                           <div class="swipe-indicator-bar">
                            <span class="index-indicator">{{ currentTaskIndex + 1 }}/{{ upcomingTasks.length }}</span>
                        </div>
                            <button (click)="goToNextTask()" [disabled]="sliderValue >= upcomingTasks.length"
                                style="background: none; border: none; color: #ffe082; font-size: 3em; cursor: pointer;">&#8594;</button>
                        </div>

                    </div>
                    <div class="next-task-compact-row">
                        <div class="next-task-compact-title">Upcoming Task</div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="next-task-compact-timer" style="justify-content: center;">
                                <span class="countdown-hour">{{ nextTaskInfo.hoursLeft | number: '2.0' }}</span>
                                <span class="countdown-sep">:</span>
                                <span class="countdown-min">{{ nextTaskInfo.minsLeft | number: '2.0' }}</span>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 1.7rem; margin-top: 0.1rem;">
                                <span style="font-size: 0.85rem; color: #e0e0e0; font-weight: 500;">Hour</span>
                                <span style="font-size: 0.85rem; color: #e0e0e0; font-weight: 500;">Minute</span>
                            </div>
                        </div>
                    </div>
                    <div class="next-task-compact-row">
                        <div class="next-task-compact-name">{{ nextTaskInfo.task.name }}</div>
                        <div class="next-task-compact-deadline">Deadline: {{ nextTaskInfo.deadlineDisplay }}</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="nextTaskInfo.progressValue"
                            [style.background]="nextTaskInfo.progressColor"></div>
                    </div>
                </div>
            </ng-container>
            <ng-template #allDone>
                <!-- <div class="next-task-card all-done">
                <div class="next-task-label">

                </div>
            </div> -->
            </ng-template>
        </div>
        <div class="dashboard-content">
            <!-- Date Controls: Row 1 (Month/Year) -->
            <div class="date-row-top">
                <select [(ngModel)]="selectedMonth" (change)="onMonthChange()" class="month-dropdown">
                    <option *ngFor="let month of months; let i = index" [value]="i">
                        {{ month }}
                    </option>
                </select>
                <input type="number" [(ngModel)]="selectedYear" (change)="onMonthChange()" class="year-input" min="2020"
                    max="2030">
                       <button class="btn-today" (click)="goToToday()">Today</button>

            </div>

            <!-- Date Controls: Row 2 (Prev/Date/Next + Today) -->
            <div class="date-row-bottom">
                <ht-button [icon]="'pi pi-chevron-left'" [text]="true" (onClick)="goToPreviousDay()" class="nav-btn">
                </ht-button>
                <div class="current-date">
                    <h2>{{ formatDate(selectedDate) }}</h2>
                    <span class="today-badge" *ngIf="isToday(selectedDate)">Today</span>
                </div>
                <ht-button [icon]="'pi pi-chevron-right'" [text]="true" (onClick)="goToNextDay()" class="nav-btn">
                </ht-button>
            </div>

            <!-- Goals Grid -->
            <div class="goals-grid" *ngIf="!loading && goalsWithTasks.length > 0">
                <div class="goal-badge" *ngFor="let goalData of goalsWithTasks"
                    [style.border-color]="getCompletionColor(goalData.completionPercentage)">
                    <div class="goal-header">
                        <h3>{{ goalData.goal.name }}</h3>
                        <div class="completion-badge"
                            [style.background-color]="getCompletionColor(goalData.completionPercentage)">
                            {{ goalData.completionPercentage }}%
                        </div>
                    </div>
                    <p class="goal-description" *ngIf="goalData.goal.description">
                        {{ goalData.goal.description }}
                    </p>
                    <div class="task-count">
                        {{ !!goalData.completedCount ? goalData.completedCount: 0 }}/{{ goalData.tasks.length }} task{{
                        goalData.tasks.length !== 1 ? 's' : '' }} done
                    </div>
                    <div class="completion-status">
                        <i class="pi" [ngClass]="goalData.completedToday ? 'pi-check-circle' : 'pi-circle'"
                            [style.color]="goalData.completedToday ? '#4caf50' : '#9e9e9e'"></i>
                        <span>{{ goalData.completedToday ? 'Entry completed for today' : 'Pending' }}</span>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="!loading && goalsWithTasks.length === 0">
                <i class="pi pi-inbox" style="font-size: 3rem; color: #9e9e9e;"></i>
                <p>No goals assigned yet</p>
                <p class="empty-subtitle">Contact your admin to get started with habit tracking</p>
            </div>

            <!-- Loading State -->
            <div class="loading-state" *ngIf="loading">
                <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                <p>Loading your goals...</p>
            </div>

            <!-- Fill Entry Button -->
            <div class="action-button" *ngIf="!loading && goalsWithTasks.length > 0">
                <ht-button [label]="'Fill Today\'s Entry'" [icon]="'pi pi-pencil'" [severity]="'primary'"
                    [fullWidth]="true" [size]="'large'" (onClick)="openDailyEntryModal()">
                </ht-button>
            </div>
        </div>
    </ht-card>

    <!-- Daily Entry Modal (placeholder - will be implemented) -->
    <app-daily-entry-modal *ngIf="showDailyEntryModal" [visible]="showDailyEntryModal" [selectedDate]="selectedDate"
        [goalsWithTasks]="goalsWithTasks" (onClose)="showDailyEntryModal = false" (onSave)="onDailyEntrySaved()">
    </app-daily-entry-modal>
</div>